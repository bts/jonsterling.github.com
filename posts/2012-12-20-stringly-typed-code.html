<!DOCTYPE html>
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
<meta name="readability-verification" content="cG3MqZcEVveKZ6mnEFkePAL3Ug79Jxxp5Fn27CM7" />
<title>JS ⊢ Eliminating Stringly-Typed Code in Objective-C</title>
<link rel="stylesheet" type="text/css" href="../css/screen.css" />
<link rel="stylesheet" type="text/css" href="../css/syntax.css" />
<link rel="stylesheet" type="text/css" href="../css/coqdoc.css" />
<style type="text/css">
    @import url(http://nmashton.ca/css/gloss-0.0.1.css);
</style>
<script type="text/javascript" src="http://code.jquery.com/jquery-1.8.3.min.js"></script>
<script type="text/javascript" src="http://nmashton.ca/js/gloss-0.0.1.js"></script>
<link rel="alternate" type="application/rss+xml" title="Jonathan Sterling" href="../rss.xml" />


<!--[if IE]>
  <script src="http://html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->
<!--[if lte IE 7]>
  <script src="js/IE8.js" type="text/javascript"></script><![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" type="text/css" media="all" href="css/ie6.css"/><![endif]-->

<script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
MathJax.Hub.Config({
  showMathMenu: false,
  showProcessingMessages: false,
  messageStyle: "none",
  'HTML-CSS': {
    availableFonts: [],
    webFont: 'TeX',
  },
  TeX: {
    Macros: {
      gk: ["\\style{font-family:Junicode!important; font-size:1.3em;}{\\text{#1}}", 1]
    }
  }
});
</script>
</head>
<body>

<header>
<h1><a href="../index.html"><span class="title">Eliminating Stringly-Typed Code in Objective-C.</span></a></h1>
</header>

<section class="post">
<article><p>Perhaps the greatest sin in the common body of Cocoa design patterns is the pervasiveness of “stringly-typed” code:<a href="#fn1" class="footnoteRef" id="fnref1"><sup>1</sup></a> it frequently comes up in KVO and bindings, among other things. Various macros have arisen to allow type checking of keypaths, largely thanks to <a href="https://github.com/jspahrsummers/libextobjc/blob/master/extobjc/EXTKeyPathCoding.h">efforts</a> by Justin Spahr-Summers and myself. Today, I’d like to talk a bit about some ideas for enforcing statically trusted boundaries for checked keypaths.</p>
<!--more-->

<h3 id="the-problem-sometimes-we-lie">The Problem: Sometimes We Lie</h3>
<p>Let’s go over the state of affairs. APIs accept strings for keypaths; we then conjure up some macro like <code>@keypath</code> to allow compile-time checking of keypaths, gaining in addition the ability for them to participate in refactoring. So, we can be sure that our own code is providing safe keypaths to the APIs it consumes.</p>
<pre class="sourceCode ObjectiveC"><code class="sourceCode objectivec">[detailView bind: @keypath(detailView.titleLabel.text)
        toObject: dogsController
     withKeyPath: @keypath(dogsController.selectedDog.name)
         options: nil];</code></pre>
<p>But the other half of the problem remains: when our own APIs use keypaths, it would be nice to enforce that these keypaths be checked. If we’re just accepting strings and hoping the client code is clever enough to use our <code>@keypath</code> macro, all is well until we begin to lie. And we all lie.</p>
<h3 id="trusted-boundaries-types-for-certified-keypaths">Trusted Boundaries: Types For Certified Keypaths</h3>
<p>Whilst we really can’t do anything about Cocoa’s APIs, we should like to force keypaths passed into our own APIs to be checked. We can do this with a type, and some clever higgle-piggling about with deprecation annotations:<a href="#fn2" class="footnoteRef" id="fnref2"><sup>2</sup></a></p>
<table class="sourceCode ObjectiveC numberLines"><tr class="sourceCode"><td class="lineNumbers"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
</pre></td><td class="sourceCode"><pre><code class="sourceCode objectivec"><span class="kw">@interface</span> CheckedKeyPath : NSObject
@property (strong, readonly) NSString *stringValue;
- (id)initWithUnsafeKeyPath:(NSString *)unsafeKeyPath DEPRECATED_ATTRIBUTE;
<span class="kw">@end</span>

<span class="kw">@interface</span> NSString (CheckedKeyPath)
- (CheckedKeyPath *)unsafeMarshalKeyPath DEPRECATED_ATTRIBUTE;
<span class="kw">@end</span>

<span class="ot">#define keypath(PATH) \</span>
_Pragma(<span class="st">&quot;clang diagnostic push&quot;</span>)\
_Pragma(<span class="st">&quot;clang diagnostic ignored </span><span class="ch">\&quot;</span><span class="st">-Wdeprecated</span><span class="ch">\&quot;</span><span class="st">&quot;</span>)\
    (strchr(# PATH, '.') + <span class="dv">1</span>).unsafeMarshalKeypath \
_Pragma(<span class="st">&quot;clang diagnostic pop&quot;</span>)</code></pre></td></tr></table>
<p>Now, the real trick is in the <code>@keypath</code> macro definition above; feel free to swap in something more advanced for the meat of the definition. The important part is that the macro includes pragmas<a href="#fn3" class="footnoteRef" id="fnref3"><sup>3</sup></a> to suppress warnings about deprecated methods, and then goes ahead and uses <code>-unsafeMarshalKeypath</code> in that scope. In this way, we can be reasonably assured (though not entirely, of course) that the only way anyone will <em>ever</em> create a term of type <code>CheckedKeyPath</code> is by using this macro.</p>
<p>Now, in our APIs, we can expose only safe interfaces for keypaths by accepting <code>CheckedKeyPath</code> rather than <code>NSString</code>; when a keypath needs to be passed to Cocoa, we can then trivially throw away the certification by sending <code>-stringValue</code>.</p>
<div class="footnotes">
<hr />
<ol>
<li id="fn1"><p>You’ll have to trust me on this one, since to enumerate the design-sins of Cocoa and Objective-C would likely take the rest of my life.<a href="#fnref1">↩</a></p></li>
<li id="fn2"><p>The implementations of these interfaces are trivial; I will leave them to your imagination.<a href="#fnref2">↩</a></p></li>
<li id="fn3"><p>We cannot use <code>#pragma</code> within a macro, but <code>_Pragma</code> works just the same.<a href="#fnref3">↩</a></p></li>
</ol>
</div></article>


<script src="//static.getclicky.com/js" type="text/javascript"></script>
<script type="text/javascript">try{ clicky.init(66625087);
    }catch(e){}</script>
<noscript><p><img alt="Clicky" width="1" height="1" src="//in.getclicky.com/66625087ns.gif" /></p></noscript>

<a rel="me" href="http://twitter.com/jonsterling"></a>
<a rel="me" href="https://alpha.app.net/jonsterling"></a>
</body>
</html>

